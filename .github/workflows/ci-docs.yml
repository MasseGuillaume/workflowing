name: Continuous Integration Documentation
on:
  pull_request:
    branches:
      - "**"
    paths:
      - "api-docs/**"
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    name: Build and publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current branch (full)
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: sleep
        run: sleep 30

      - name: Check And Build docs
        working-directory: api-docs/
        run: "./generate-docs.sh"

      # https://docs.narrative.io/open-api/my-feature
      - name: Publish to S3 based on the branch
        working-directory: api-docs/
        run: 'echo "generated-docs s3://narrative-cdn-docs/open-api/${{ github.head_ref || github.ref_name }}"'
        if: ${{github.ref_type == 'branch' && github.ref_name != 'main'}}

      # clean up the tag name
      - name: Set Versions
        uses: actions/github-script@v4
        id: set_version
        with:
          script: |
            const tag = context.ref.substring(10)
            const no_v = tag.replace('v', '')
            const dash_index = no_v.lastIndexOf('-')
            const no_dash = (dash_index > -1) ?  no_v.substring(0, dash_index) : no_v
            core.setOutput('value', no_dash)
        if: ${{github.ref_type == 'tag'}}

      # https://docs.narrative.io/open-api/1.2.3
      - name: Publish to S3 based on the tag
        working-directory: api-docs/
        run: 'echo "generated-docs s3://narrative-cdn-docs/open-api/${{ steps.set_version.outputs.value }}"'
        if: ${{github.ref_type == 'tag'}}
